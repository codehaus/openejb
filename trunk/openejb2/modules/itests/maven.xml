<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- $Revision$ $Date$ -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant"
    xmlns:deploy="geronimo:deploy"
    xmlns:maven="jelly:maven"
    >

    <preGoal name="xdoc:jelly-transform">
        <attainGoal name="html2xdoc"/>
    </preGoal>


    <preGoal name="test:test">
        <ant:delete dir="${maven.build.dir}/openejb"/>
        <deploy:unpackServer
            geronimoVersion="2.0-SNAPSHOT"
            geronimoName="openejb"
            targetDir="${maven.build.dir}/openejb"/>
        <deploy:startRemoteServer
            geronimoTarget="${maven.build.dir}/openejb"
            configs="org/apache/geronimo/DefaultDatabase"/>
        <deploy:waitForStarted
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/apache/geronimo/DefaultDatabase"/>
        <echo message="server has started"/>
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            home="${basedir}"
            module="${maven.repo.local}/openejb/ejbs/openejb-itests-ejb-${pom.currentVersion}.jar"
            />
        <echo message="distributed ejbs"/>
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Itests"/>
        <j:set var="maven.test.failure.ignore" value="true"/>
    </preGoal>

    <postGoal name="test:test">
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Itests"/>
        <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Itests"/>
        <deploy:stopRemoteServer
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"/>
    </postGoal>

</project>
