<?xml version="1.0" encoding="ISO-8859-1"?>

<!-- $Revision$ $Date$ -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant"
    xmlns:deploy="geronimo:deploy"
    xmlns:maven="jelly:maven"
    xmlns:u="jelly:util"
    xmlns:define="jelly:define"
    >

    <preGoal name="xdoc:jelly-transform">
        <attainGoal name="html2xdoc"/>
    </preGoal>

    <goal name="default" prereqs="ejb:install"/>

    <postGoal name="ejb:install">
        <attainGoal name="itest"/>
    </postGoal>

    <preGoal name="itest:setup">
        <ant:delete dir="${maven.build.dir}/openejb"/>
        <deploy:unpackServer
            geronimoVersion="${openejb_version}"
            geronimoName="openejb"
            targetDir="${maven.build.dir}/openejb"/>
        <ant:copy todir="${maven.build.dir}/openejb/var/certstores">
            <ant:fileset dir="src/test-resources" includes="keystore,truststore"/>
        </ant:copy>
        <deploy:startRemoteServer
            geronimoTarget="${maven.build.dir}/openejb"
            vmArgs="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005 -Xmx512m -XX:MaxPermSize=128m -Djava.rmi.server.RMIClassLoaderSpi=org.apache.geronimo.system.rmi.RMIClassLoaderSpiImpl"
            configs="org/openejb/Security"/>
        <ant:echo message="Waiting for server at: ${geronimoTarget}"/>
        <deploy:waitForStarted
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Security"/>
        <echo message="server has started"/>
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            module="${basedir}/target/openejb-itests-${pom.currentVersion}.jar"
            />
        <echo message="distributed ejbs"/>
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Itests"/>
        <ant:jar destfile="${basedir}/target/openejb-security-001.jar">
            <fileset dir="${basedir}/target/classes" includes="**/security/**/*.class"/>
            <metainf dir="${basedir}/src/scenarios/001" includes="*.xml"/>
        </ant:jar>

        <ant:jar destfile="${basedir}/target/openejb-security-002.jar">
            <fileset dir="${basedir}/target/classes" includes="**/security/**/*.class"/>
            <metainf dir="${basedir}/src/scenarios/002" includes="*.xml"/>
        </ant:jar>

        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            module="${basedir}/target/openejb-security-001.jar"
            />
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            module="${basedir}/target/openejb-security-002.jar"
            />
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario001"/>
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario002"/>
    </preGoal>

    <preGoal name="itest:teardown">
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario002"/>
        <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario002"/>
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario001"/>
        <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario001"/>
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Itests"/>
        <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Itests"/>
        <echo message="undeployed ejbs"/>
        <deploy:stopRemoteServer
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"/>
        <echo message="server has stopped"/>
    </preGoal>
    
    <goal name="svr:start">
        <deploy:startRemoteServer
            geronimoTarget="${maven.build.dir}/openejb"
            vmArgs="-Xmx512m -XX:MaxPermSize=128m -Djava.rmi.server.RMIClassLoaderSpi=org.apache.geronimo.system.rmi.RMIClassLoaderSpiImpl"
            configs="org/openejb/Security"/>
        <ant:echo message="Waiting for server at: ${geronimoTarget}"/>
        <deploy:waitForStarted
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/Security"/>
        <echo message="server has started"/>
    </goal>
    
    <goal name="svr:stop">
        <deploy:stopRemoteServer
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"/>
        <echo message="server has stopped"/>
    </goal>
    
    <goal name="sec:start">
        <ant:jar destfile="${basedir}/target/openejb-security-001.jar">
            <fileset dir="${basedir}/target/classes" includes="**/security/**/*.class"/>
            <metainf dir="${basedir}/src/scenarios/001" includes="*.xml"/>
        </ant:jar>
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            module="${basedir}/target/openejb-security-001.jar"
            />
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario001"/>
    </goal>

    <goal name="sec:stop">
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario001"/>
        <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/openejb/scenario001"/>
    </goal>

</project>
