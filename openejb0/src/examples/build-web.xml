<project name="Example--Web" default="jar" basedir="./">
    <property name="src.web.dir" value="${src.dir}/web"/>
    <property name="build.web.src" value="${build.src}/web"/>
    <property name="build.web.dest" value="${build.dest}/web"/>
    <property name="build.ejb.dest" value="${build.dest}/ejb"/>
    <property name="example.jar" value="${project}_clients-${version}.jar"/>
    <property name="example.war" value="${project}_web-${version}.war"/>
        
    <path id="project.classpath">
        <pathelement location="${ejb11.jar}"/>
        <pathelement location="${jndi.jar}"/>
        <pathelement location="${servlet.jar}"/>
        <pathelement location="${build.ejb.dest}"/>
    </path>
    
    <target name="prepare">
        <mkdir dir="${build.web.src}"/>
        <mkdir dir="${build.web.dest}"/>
        <copy todir="${build.web.src}">        
	        <fileset dir="${src.web.dir}">
	            <exclude name="**/CVS/**"/>
	            <exclude name="**/*.class"/>
	        </fileset>
        </copy>
    </target>

    <target name="copy.manifest">
        <copy file="${src.web.dir}/META-INF/MANIFEST.MF"
              todir="${build.web.dest}/META-INF">
			<filterset>
			  <filter token="$$VERSION$$" value="${version}"/>
			</filterset>
        </copy>
        <copy file="${src.web.dir}/WEB-INF/web.xml"
              todir="${build.web.dest}/WEB-INF"/>
    </target>
    
    <target name="compile"
        depends="prepare, compile.jdk12, compile.jdk13"
        description="--> compiles the java source files">
    </target>
    
    <target name="compile.jdk12" unless="jdk13">
        <delete>
            <fileset dir="${build.openejb.server.src}" includes="**/Jdk13*.java"/>
        </delete>
        <javac srcdir="${build.web.src}"
            destdir="${build.web.dest}"
            debug="${debug}"
            deprecation="${deprecation}">
        
            <classpath>
                <path refid="project.classpath"/>
                <pathelement location="${build.dest}/openejb"/>
                <pathelement location="${build.dest}/loader"/>
            </classpath>
        </javac>
    </target>
    
    <target name="compile.jdk13" if="jdk13">
        <javac srcdir="${build.web.src}"
            destdir="${build.web.dest}"
            debug="${debug}"
            deprecation="${deprecation}">
            <classpath>
                <path refid="project.classpath"/>
                <pathelement location="${build.dest}/openejb"/>
                <pathelement location="${build.dest}/loader"/>
            </classpath>
        </javac>
    </target>
    
    <target name="jar"
        depends="compile, copy.manifest"
        description="--> generates Web ARchive (default)">
    
        <war warfile="${openejb.dir}/dist/${example.war}"
            webxml="${build.web.dest}/WEB-INF/web.xml">
            <fileset dir="${build.web.src}">
                <include name="**/*.jsp"/>
                <exclude name="**/*.java"/>
            </fileset>
            <classes dir="${build.web.dest}">
                <include name="**/*.class"/>
            </classes>
        </war>              
    </target>

    <target name="set_properties">
        <available 
            file="${openejb.dir}/dist/${project}_web-${version}.war"
            property="examples.present"
            classpathref="project.classpath"
        />
        <available 
            file="${openejb.dir}/dist/openejb_loader-${openejb.version}.war"
            property="loader.present"
            classpathref="project.classpath"
         />   
    </target>

    <target name="check.loader" unless="loader.present"
        depends="set_properties">
        <antcall target="property-warning">
        	<param name="name" value="OpenEJB's Tomcat Loader"/>
            <param name="value" value="${openejb.dir}/dist/openejb_loader-${openejb.version}.war"/>
        </antcall>
    </target>
                                            
	<target name="property-warning">
		<echo>
      +----------------------------------------------------------------+
	  + F A I L E D  R E Q U I R E M E N T                             |
	  +----------------------------------------------------------------+
	  | You must build OpenEJB before building the examples.           |
	  |                                                                |
	  | The following file is not available at a given path:           |
	  |                                                                |
	  | ${name} = ${value}
	  |
	  | You can work it out by:                                        |
	  |  o go to ${openejb.dir} and issue 'openejb build'
	  +----------------------------------------------------------------+
		</echo>
		<fail message="Failed Requirement"/>
	</target>

    <target name="install"
        depends="check.loader"
        description="--> installs onto Tomcat">
        <copy todir="${tomcat.dir}/webapps">
            <fileset dir="${openejb.dir}/dist" >
                <include name="${project}_web-${version}.war"/>
                <include name="openejb_loader-${openejb.version}.war"/>
            </fileset>
        </copy>
    </target>
      
    <target name="clean"
        description="--> cleans up the jars">
        <delete file="${openejb.dir}/dist/${project}_web-${version}.war"/>
    </target>
</project>
