<?xml version="1.0" encoding="UTF-8"?>

<!-- $Revision: 2513 $ $Date: 2006-02-25 21:53:47 -0800 (Sat, 25 Feb 2006) $ -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:u="jelly:util">

    <!--======================-->
    <!--   Tomcat profiles    -->
    <!--======================-->

    <goal name="tomcat55">
      <j:set var="tomcat.branch" value="5"/>
      <j:set var="tomcat.version" value="5.5.15"/>
      <j:set var="tomcat.prefix" value="apache"/>
      <attainGoal name="tomcat.env"/>
    </goal>

    <goal name="tomcat50">
      <j:set var="tomcat.branch" value="5"/>
      <j:set var="tomcat.version" value="5.0.30"/>
      <j:set var="tomcat.prefix" value="jakarta"/>
      <attainGoal name="tomcat.env"/>
    </goal>

    <goal name="tomcat4">
      <j:set var="tomcat.branch" value="4"/>
      <j:set var="tomcat.version" value="4.1.31"/>
      <j:set var="tomcat.prefix" value="jakarta"/>
      <attainGoal name="tomcat.env"/>
    </goal>

    <goal name="tomcat.env">
      <j:set var="targetDir" value="${basedir}/target/"/>
      <j:set var="tomcat.home" value="${targetDir}/${tomcat.prefix}-tomcat-${tomcat.version}"/>
      <j:set var="openejb.home" value="${targetDir}/openejb-${openejb.version}" />
    </goal>

    <!--======================-->
    <!--   Setup/cleanup      -->
    <!--======================-->

    <goal name="setup:openejb">
      <j:set var="targetDir" value="${basedir}/target/"/>
      <j:set var="openejb.home" value="${targetDir}/openejb-${openejb.version}" />
      <j:set var="openejb.dist" value="${targetDir}/openejb-${openejb.version}-bin.zip" />

      <u:file var="fileAsFile" name="${openejb.home}"/>
      <j:if test="${!(fileAsFile.exists())}">
        <unjar src="${openejb.dist}" dest="${targetDir}"/>
        <copy file="${targetDir}/openejb-${openejb.version}-test.jar" todir="${openejb.home}/beans" />
      </j:if>
    </goal>

    <goal name="setup:tomcat">
      <j:set var="targetDir" value="${basedir}/target/"/>

      <j:set var="tomcat.download" value="http://www.ibiblio.org/pub/mirrors/apache/tomcat/tomcat-${tomcat.branch}/v${tomcat.version}/bin/${tomcat.prefix}-tomcat-${tomcat.version}.zip"/>

      <j:set var="tomcat.src" value="${maven.repo.local}/tomcat/distributions/${tomcat.prefix}-tomcat-${tomcat.version}.zip"/>
      <j:set var="tomcat.dist" value="${maven.repo.local}/tomcat/distributions/${tomcat.prefix}-tomcat-${tomcat.version}.zip"/>
      <j:set var="tomcat.home" value="${targetDir}/${tomcat.prefix}-tomcat-${tomcat.version}"/>
      <j:set var="openejb.home" value="${targetDir}/openejb-${openejb.version}" />

      <!-- Download tomcat if it isn't in the repo -->
      <u:file var="fileAsFile" name="${tomcat.dist}"/>
      <j:if test="${!(fileAsFile.exists())}">
        <mkdir dir="${maven.repo.local}/tomcat/distributions"/>
        <get src="${tomcat.download}" dest="${tomcat.dist}"/>
      </j:if>

      <!-- Unzip if not unzipped -->
      <u:file var="fileAsFile" name="${tomcat.home}"/>
      <j:if test="${!(fileAsFile.exists())}">
        <unjar src="${tomcat.dist}" dest="${targetDir}"/>
        <chmod dir="${tomcat.home}/bin" perm="u+x" includes="**/*.sh"/>
      </j:if>
    </goal>

    <goal name="setup:tomcat-src">
      <j:set var="targetDir" value="${basedir}/src/"/>

      <j:set var="tomcat.download" value="http://www.ibiblio.org/pub/mirrors/apache/tomcat/tomcat-${tomcat.branch}/v${tomcat.version}/src/${tomcat.prefix}-tomcat-${tomcat.version}-src.zip"/>
      <j:set var="tomcat.dist" value="${maven.repo.local}/tomcat/distributions/${tomcat.prefix}-tomcat-${tomcat.version}-src.zip"/>

      <!-- Download tomcat if it isn't in the repo -->
      <u:file var="fileAsFile" name="${tomcat.dist}"/>
      <j:if test="${!(fileAsFile.exists())}">
        <mkdir dir="${maven.repo.local}/tomcat/distributions"/>
        <get src="${tomcat.download}" dest="${tomcat.dist}"/>
      </j:if>

      <unjar src="${tomcat.dist}" dest="${basedir}"/>
    </goal>

    <goal name="delete:tomcat">
      <delete dir="${tomcat.home}"/>
    </goal>

    <!--======================-->
    <!--   Start/stop         -->
    <!--======================-->

    <goal name="start:tomcat">
      <j:choose>
        <j:when test="${systemScope['os.name'].startsWith('Windows')}">
          <exec executable="${tomcat.home}/bin/startup.bat" os="Windows NT,Windows 2000,Windows XP">
            <env key="CATALINA_HOME" value="${tomcat.home}"/>
          </exec>
        </j:when>
        <j:otherwise>
          <exec executable="${tomcat.home}/bin/startup.sh"/>
        </j:otherwise>
      </j:choose>
    </goal>

    <goal name="start:tomcat-debug">
      <j:choose>
        <j:when test="${systemScope['os.name'].startsWith('Windows')}">
          <exec executable="${tomcat.home}/bin/startup.bat" os="Windows NT,Windows 2000,Windows XP">
            <env key="JAVA_OPTS" value="-Dopenejb.home=${openejb.home} -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>
            <env key="CATALINA_HOME" value="${tomcat.home}"/>
          </exec>
        </j:when>
        <j:otherwise>
          <exec executable="${tomcat.home}/bin/startup.sh">
            <env key="JAVA_OPTS" value="-Dopenejb.home=${openejb.home} -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005"/>
          </exec>
        </j:otherwise>
      </j:choose>
    </goal>

    <goal name="stop:tomcat">
      <j:choose>
        <j:when test="${systemScope['os.name'].startsWith('Windows')}">
          <exec executable="${tomcat.home}/bin/shutdown.bat"
                os="Windows NT,Windows 2000,Windows XP">
            <env key="CATALINA_HOME" value="${tomcat.home}"/>
          </exec>
        </j:when>
        <j:otherwise>
          <exec executable="${tomcat.home}/bin/shutdown.sh" />
        </j:otherwise>
      </j:choose>
    </goal>


    <!--======================-->
    <!--   Deploy             -->
    <!--======================-->

    <goal name="setup:loader-webapp">
      <!-- Unzip webapp and set openejb.home -->
      <mkdir dir="${tomcat.home}/webapps/openejb"/>
      <unjar src="${openejb.home}/war/openejb-loader-${openejb.version}.war" dest="${tomcat.home}/webapps/openejb"/>
      <replace file="${tomcat.home}/webapps/openejb/WEB-INF/web.xml" token="@OPENEJB_HOME@" value="${openejb.home}"/>
    </goal>

    <goal name="setup:itests-webapp">
      <!-- Unzip webapp and set openejb.home -->
      <mkdir dir="${tomcat.home}/webapps/itests"/>
      <unjar src="${basedir}/modules/itests-webapp/target/openejb-itests-webapp.war" dest="${tomcat.home}/webapps/itests"/>
      <replace file="${tomcat.home}/webapps/itests/WEB-INF/web.xml" token="@OPENEJB_HOME@" value="${openejb.home}"/>
    </goal>

    <goal name="setup:webapp-example">
      <j:set var="targetDir" value="${basedir}/target/"/>
      <j:set var="tomcat.home" value="${targetDir}/${tomcat.prefix}-tomcat-${tomcat.version}"/>
      <j:set var="openejb.home" value="${targetDir}/openejb-${openejb.version}" />
      <!-- Unzip webapp and set openejb.home -->
      <mkdir dir="${tomcat.home}/webapps/openejb"/>
      <unjar src="${openejb.home}/war/openejb-webapp-examples-${openejb.version}.war" dest="${tomcat.home}/webapps/movies"/>
      <replace file="${tomcat.home}/webapps/movies/WEB-INF/web.xml" token="@OPENEJB_HOME@" value="${openejb.home}"/>
    </goal>


    <!--======================-->
    <!--   Testing profiles   -->
    <!--======================-->

    <goal name="test:local" prereqs="setup:openejb">
      <java classname="org.openejb.test.Main" fork="yes">
        <classpath>
          <pathelement location="${basedir}/target/openejb-${openejb.version}-test.jar"/>
          <fileset dir="${basedir}/target/openejb-${openejb.version}/lib">
            <include name="**/*.jar"/>
          </fileset>
        </classpath>
        <sysproperty key="openejb.home" value="target/openejb-${openejb.version}"/>
        <arg value="local"/>
      </java>
    </goal>

    <goal name="test:remote" prereqs="setup:openejb">
      <java jar="target/openejb-${openejb.version}-test.jar" fork="yes">
        <sysproperty key="openejb.home" value="${basedir}/target/openejb-${openejb.version}"/>
        <arg value="remote"/>
      </java>
    </goal>

    <goal name="test:http" prereqs="setup:openejb">
      <java jar="target/openejb-${openejb.version}-test.jar" fork="yes">
        <sysproperty key="openejb.home" value="target/openejb-${openejb.version}"/>
        <arg value="http"/>
      </java>
    </goal>

    <goal name="test:tomcat" prereqs="setup:openejb">
      <attainGoal name="setup:tomcat"/>
      <attainGoal name="setup:loader-webapp"/>
      <!--<attainGoal name="start:tomcat"/>-->
      <java jar="target/openejb-${openejb.version}-test.jar" fork="yes">
        <sysproperty key="openejb.home" value="target/openejb-${openejb.version}"/>
        <sysproperty key="tomcat.home" value="${tomcat.home}"/>
        <sysproperty key="remote.servlet.url" value="http://127.0.0.1:8080/openejb/remote"/>
        <arg value="tomcat"/>
      </java>
      <!--<attainGoal name="stop:tomcat"/>-->
    </goal>

    <goal name="test:tomcat-webapp" prereqs="setup:openejb">
      <attainGoal name="setup:tomcat"/>
      <attainGoal name="setup:itests-webapp"/>
      <!--<attainGoal name="start:tomcat"/>-->
      <java jar="target/openejb-${openejb.version}-test.jar" fork="yes">
        <sysproperty key="openejb.home" value="target/openejb-${openejb.version}"/>
        <sysproperty key="tomcat.home" value="${tomcat.home}"/>
        <sysproperty key="remote.serlvet.url" value="http://127.0.0.1:8080/itests/remote"/>
        <arg value="tomcat"/>
      </java>
      <!--<attainGoal name="stop:tomcat"/>-->
    </goal>

    <goal name="test:tomcat-all">
      <attainGoal name="tomcat4"/>
      <attainGoal name="test:tomcat"/>
      <attainGoal name="delete:tomcat"/>
      <attainGoal name="test:tomcat-webapp"/>
      <attainGoal name="delete:tomcat"/>

      <attainGoal name="tomcat50"/>
      <attainGoal name="test:tomcat"/>
      <attainGoal name="delete:tomcat"/>
      <attainGoal name="test:tomcat-webapp"/>
      <attainGoal name="delete:tomcat"/>
      <j:if test="${systemScope['java.version'].startsWith('1.5')}">
        <attainGoal name="tomcat55"/>
        <attainGoal name="test:tomcat"/>
        <attainGoal name="delete:tomcat"/>
        <attainGoal name="test:tomcat-webapp"/>
        <attainGoal name="delete:tomcat"/>
      </j:if>
    </goal>

    <goal name="test:all">
      <attainGoal name="test:local"/>
      <attainGoal name="test:remote"/>
      <attainGoal name="test:http"/>
      <attainGoal name="test:tomcat-all"/>
    </goal>
<!-- Try this if things get rough
java -Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005 -jar target/openejb-1.0-SNAPSHOT/lib/openejb-core-1.0-SNAPSHOT.jar start
-->

</project>
